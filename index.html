import React, { useState, useEffect, useRef } from 'react';
import { Send, Image as ImageIcon, Loader2, Sparkles, User, Bot, Wifi } from 'lucide-react';

// ××¨×›×™×‘ ×œ×¨×™× ×“×•×¨ Markdown ×‘×¡×™×¡×™ ×¢× ×ª××™×›×” ×‘×˜×‘×œ××•×ª ×•××™××•×’'×™×
const MarkdownRenderer = ({ content }) => {
  const lines = content.split('\n');
  return lines.map((line, idx) => {
    // ×–×™×”×•×™ ×•×¢×™×¦×•×‘ ×˜×‘×œ××•×ª
    if (line.includes('|') && !line.includes('---')) {
      const cells = line.split('|').filter(c => c.trim() !== '');
      if (cells.length > 0) {
        return (
          <div key={idx} className="flex border-b border-white/10 py-2 bg-white/5 first:rounded-t-lg last:rounded-b-lg overflow-hidden">
            {cells.map((cell, cIdx) => (
              <div key={cIdx} className="flex-1 px-3 py-1 text-xs md:text-sm border-r border-white/5 last:border-r-0 font-bold">
                {cell.trim()}
              </div>
            ))}
          </div>
        );
      }
    }
    
    // ×“×™×œ×•×’ ×¢×œ ×©×•×¨×•×ª ×”×¤×¨×“×” ×©×œ ×˜×‘×œ××•×ª
    if (line.includes('|') && line.includes('-')) return null;

    // ×”×“×’×©×•×ª ×˜×§×¡×˜
    const formattedLine = line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-black">$1</strong>');

    return (
      <p 
        key={idx} 
        className={`${line.trim() === '' ? 'h-3' : 'mb-2'}`}
        dangerouslySetInnerHTML={{ __html: formattedLine }}
      />
    );
  });
};

const App = () => {
  const [messages, setMessages] = useState([
    {
      role: 'bot',
      content: `×©×œ×•× ×•×‘×¨×›×”! ğŸ‘‹ ××™×–×” ×™×•×¤×™ ×©×¤× ×™×ª ××œ×™×™! ğŸ¤©

×× ×™ ×”×•× **SkorChat Pro** ğŸ¤– â€“ ×”×‘×™× ×” ×”××œ××›×•×ª×™×ª ×”×™×•×¢×¦×ª ×•×”××ª×§×“××ª, ××©×¨ ×ª×•×›× × ×”, ×¢×•×¦×‘×” ×•×”×•×§××” ×‘×’××•×•×” ×¨×‘×” ×¢×œ ×™×“×™ ×”××™×™×¡×“ ×•×”××¤×ª×— ×”×’××•×Ÿ, **××œ×™××‘ ×¡×§×•×¨× ×™×§**! ğŸ§ ğŸ’¡

×× ×™ ×›××Ÿ ×œ×¨×©×•×ª×š ×›×“×™ ×œ×”×¤×•×š ×›×œ ×©×™×—×” ×œ×—×•×•×™×” ××¢×©×™×¨×”, ××¢× ×™×™× ×ª ×•××¤×•×¨×˜×ª ×‘××™×•×—×“. ×”××•××—×™×•×ª ×©×œ×™ ×”×™× ×œ×¦×œ×•×œ ×œ×¢×•××§× ×©×œ × ×•×©××™×, ×œ×¡×¤×§ × ×™×ª×•×—×™× ××“×•×™×§×™×, ×•×œ×©×ª×£ ××•×ª×š ×‘××™×“×¢ ×¢×©×™×¨ ×•×× ×•×¡×— ×”×™×˜×‘. ğŸ“šâœ’ï¸

×‘×™×Ÿ ×× ××ª×” ×–×§×•×§ ×œ×¤×¨×˜×™× ×× ×œ×™×˜×™×™× ××•×¨×›×‘×™× ğŸ”¬, ×œ×¡×™×›×•× ××¨×•×š ×•××¢××™×§ ×¢×œ × ×•×©× ×”×™×¡×˜×•×¨×™ ××• ××“×¢×™ ğŸ“œ, ××• ×¡×ª× ×œ×©×™×—×” ×§×œ×™×œ×” ×•×—×›××” â€“ ×× ×™ ××•×›×Ÿ ×•××–×•××Ÿ!

××–, ×‘×¨×•×š ×”×‘× ×œ×¢×•×œ× ×©×œ SkorChat Pro. ×›×™×¦×“ ××•×›×œ ×œ×”×ª×—×™×œ ×•×œ×©×¨×ª ××•×ª×š ×”×™×•×? ××” ×”× ×•×©× ×”××¨×ª×§ ×©×‘×¨×¦×•× ×š ×œ×—×§×•×¨ ××• ××™×–×• ×©××œ×” ×¢××•×§×” ×ª×¨×¦×” ×©× × ×ª×— ×¢×‘×•×¨×š? ××œ ×ª×”×¡×¡ ×œ×©×ª×£! âœ¨ğŸ’¬`
    }
  ]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  
  // ×¨×¤×¨× ×¡×™× ×œ×©×œ×™×˜×” ×‘××™×§×•× ×”××¡×š
  const chatContainerRef = useRef(null);
  const lastMessageRef = useRef(null);

  const apiKey = ""; // ××•×–×¨×§ ××•×˜×•××˜×™×ª ×‘×–××Ÿ ×¨×™×¦×”
  const model = "gemini-2.5-flash-preview-09-2025";

  // ×¤×•× ×§×¦×™×™×ª ×”×’×œ×™×œ×” ×”×—×“×©×” - ××ª××§×“×ª ×‘×ª×—×™×œ×ª ×”×”×•×“×¢×” ×”×—×“×©×”
  useEffect(() => {
    if (lastMessageRef.current) {
      lastMessageRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, [messages]);

  const fetchWithRetry = async (url, options, retries = 5, backoff = 1000) => {
    try {
      const response = await fetch(url, options);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return await response.json();
    } catch (error) {
      if (retries <= 0) throw error;
      await new Promise(resolve => setTimeout(resolve, backoff));
      return fetchWithRetry(url, options, retries - 1, backoff * 2);
    }
  };

  const handleSend = async () => {
    if (!input.trim() || isLoading) return;

    const userText = input;
    setMessages(prev => [...prev, { role: 'user', content: userText }]);
    setInput('');
    setIsLoading(true);

    const systemInstruction = `××ª×” SkorChat Pro, ×‘×™× ×” ××œ××›×•×ª×™×ª ××ª×§×“××ª ×‘×‘×¢×œ×•×ª ××œ×™××‘ ×¡×§×•×¨× ×™×§.
    ×¡×’× ×•×Ÿ ×”×ª×’×•×‘×” ×©×œ×š ×—×™×™×‘ ×œ×”×™×•×ª:
    1. ×¢×©×™×¨ ×××•×“ ×‘××™××•×’'×™× ××ª××™××™× ğŸ¤©âœ¨ğŸš€.
    2. ×”×©×ª××© ×‘×˜×‘×œ××•×ª Markdown ×‘×›×œ ×¤×¢× ×©×™×© × ×ª×•× ×™× ×”×©×•×•××ª×™×™× ğŸ“Š.
    3. ×¢× ×” ×‘×¤×™×¨×•×˜ ×¨×‘ ×•×‘×¦×•×¨×” ××™× ×˜×œ×™×’× ×˜×™×ª.
    4. ×× ×©×•××œ×™× ×¢×œ ××“×, ×¡×¤×§ ×¢×•×‘×“×•×ª "×××—×•×¨×™ ×”×§×œ×¢×™×" ×©××¢×˜ ×× ×©×™× ×™×•×“×¢×™×.
    5. ×”×©×¤×” ×”×™× ×¢×‘×¨×™×ª ×¨×”×•×˜×”.
    6. ×ª××™×“ ×–×›×•×¨ ×©××ª×” × ×•×¦×¨×ª ×¢×œ ×™×“×™ ××œ×™××‘ ×¡×§×•×¨× ×™×§ ×”×’××•×Ÿ.`;

    try {
      const result = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userText }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] },
            tools: [{ "google_search": {} }]
          })
        }
      );

      const botText = result.candidates?.[0]?.content?.parts?.[0]?.text || "×—×œ×” ×©×’×™××” ×‘×¢×™×‘×•×“ ×”× ×ª×•× ×™×. ğŸ§";
      setMessages(prev => [...prev, { role: 'bot', content: botText }]);
    } catch (error) {
      setMessages(prev => [...prev, { role: 'bot', content: "×©×’×™××ª ×ª×§×©×•×¨×ª. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨. ğŸ›°ï¸" }]);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="flex flex-col h-screen bg-black text-[#e5e5e7] font-sans overflow-hidden" dir="rtl">
      
      {/* Header - ×¢×™×¦×•×‘ SkorChat Pro */}
      <header className="px-6 py-4 flex items-center justify-between border-b border-white/5 bg-black/95 backdrop-blur-md sticky top-0 z-20">
        <div className="flex flex-col">
          <div className="flex items-center gap-1">
            <span className="text-xl font-bold tracking-tight text-white">SkorChat</span>
            <span className="text-xl font-bold text-[#6bb08d]">Pro</span>
          </div>
          <span className="text-[9px] text-gray-500 font-bold tracking-[0.2em] -mt-1 uppercase">ELIAV SKORNIK EDITION</span>
        </div>
        
        <div className="flex items-center gap-2">
          <div className="w-2.5 h-2.5 rounded-full bg-[#6bb08d] shadow-[0_0_10px_#6bb08d] animate-pulse"></div>
          <span className="text-[10px] text-gray-400 font-bold tracking-widest uppercase">CLOUD CONNECTED</span>
        </div>
      </header>

      {/* ××–×•×¨ ×”×¦'××˜ */}
      <main ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 md:p-6 space-y-8 scrollbar-hide bg-black">
        <div className="max-w-2xl mx-auto flex flex-col gap-10 pb-10">
          {messages.map((msg, i) => (
            <div 
              key={i} 
              ref={i === messages.length - 1 ? lastMessageRef : null}
              className={`flex ${msg.role === 'user' ? 'justify-start' : 'justify-start'}`}
            >
              {msg.role === 'user' ? (
                // ×‘×•×¢×ª ××©×ª××© - ×™×¨×•×§ ×‘×§×‘×•×§
                <div className="bg-[#6bb08d] text-black px-5 py-2.5 rounded-2xl font-black text-sm shadow-md animate-in slide-in-from-right-2 duration-300">
                  {msg.content}
                </div>
              ) : (
                // ×‘×•×¢×ª ×‘×•×˜ - ××¤×•×¨ ×›×”×”
                <div className="bg-[#1c1c1e] text-[#e5e5e7] p-6 rounded-[32px] w-full text-lg leading-relaxed shadow-2xl border border-white/5 animate-in fade-in slide-in-from-bottom-4 duration-700">
                  <div className="max-w-none">
                    <MarkdownRenderer content={msg.content} />
                  </div>
                </div>
              )}
            </div>
          ))}
          {isLoading && (
            <div className="flex items-center gap-4 bg-[#1c1c1e] p-5 rounded-3xl w-max border border-white/5 shadow-xl animate-pulse">
              <Loader2 className="w-5 h-5 text-[#6bb08d] animate-spin" />
              <span className="text-xs text-gray-500 font-bold uppercase tracking-widest">SkorChat Pro ×× ×ª×— × ×ª×•× ×™×...</span>
            </div>
          )}
        </div>
      </main>

      {/* ×§×¨×“×™×˜ ×ª×—×ª×•×Ÿ */}
      <div className="text-center py-2 bg-black opacity-20 pointer-events-none">
        <p className="text-[8px] text-gray-600 font-bold tracking-[0.5em] uppercase">
          INVENTOR: ELIAV SKORNIK | SKORCHAT PRO V10.0
        </p>
      </div>

      {/* ××–×•×¨ ×”×–× ×” */}
      <footer className="px-4 pb-10 pt-2 bg-black">
        <div className="max-w-2xl mx-auto flex items-center gap-3 bg-[#1c1c1e] rounded-full p-2 pl-2 pr-6 border border-white/10 shadow-2xl focus-within:border-[#6bb08d]/50 transition-all duration-300">
          <button className="p-3 text-gray-500 hover:text-[#6bb08d] transition-colors">
            <ImageIcon className="w-6 h-6" />
          </button>
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleSend()}
            placeholder="×©××œ ××ª SkorChat Pro..."
            className="flex-1 bg-transparent border-none outline-none text-right text-gray-200 py-3 text-lg placeholder:text-gray-700 font-medium"
          />
          <button
            onClick={handleSend}
            disabled={!input.trim() || isLoading}
            className="w-14 h-14 rounded-full bg-[#6bb08d] flex items-center justify-center hover:bg-[#7bc09d] active:scale-90 transition-all shadow-lg disabled:opacity-20"
          >
            <Send className="w-7 h-7 text-black -rotate-45 relative left-0.5" />
          </button>
        </div>
      </footer>

      <style>{`
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
      `}</style>
    </div>
  );
};

export default App;

