<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¦ SkorChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Heebo', sans-serif;
      height: 100vh;
      margin: 0;
      display: flex;
      animation: rainbowBG 10s infinite;
      background-size: 400% 400%;
    }
    @keyframes rainbowBG {
      0% { background: red; }
      20% { background: orange; }
      40% { background: yellow; }
      60% { background: green; }
      80% { background: cyan; }
      100% { background: red; }
    }
    .user-message, .bot-message {
      max-width: 80%;
      padding: 1rem;
      border-radius: 1.5rem;
      margin-bottom: 0.5rem;
      background: rgba(255,255,255,0.8);
      color: black;
    }
    .user-message { align-self: flex-end; }
    .bot-message { align-self: flex-start; }
  </style>
</head>
<body>
  <!-- Sidebar Categories -->
  <div class="w-1/4 bg-black/70 text-white p-4">
    <h2 class="text-lg font-bold mb-4">ğŸ“‚ ×§×˜×’×•×¨×™×•×ª</h2>
    <div id="categories" class="space-y-2"></div>
  </div>

  <!-- Chat Section -->
  <div class="flex-1 flex flex-col">
    <div class="top-bar bg-black/70 p-4 text-white flex justify-between items-center border-b-2 border-white">
      <h1 class="text-xl font-bold">ğŸ¦ SkorChat</h1>
      <div>
        <span id="status-dot" class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span>
        <span id="status-text" class="text-sm">×× ×•×ª×§</span>
      </div>
    </div>

    <div id="chat" class="flex-1 p-4 overflow-y-auto flex flex-col"></div>

    <div class="input-bar bg-black/70 p-3 flex gap-2 items-center border-t-2 border-white">
      <input id="input" type="text" placeholder="×”×§×œ×“ ×›××Ÿ..." class="flex-1 p-2 rounded-xl text-black" />
      <input id="imageInput" type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event)" />
      <button onclick="document.getElementById('imageInput').click()" class="bg-blue-500 text-white px-3 py-2 rounded-lg">ğŸ“·</button>
      <button onclick="sendMessage()" class="bg-yellow-400 text-black font-bold px-6 py-3 rounded-xl shadow-lg">×©×œ×—</button>
      <button onclick="clearChat()" class="bg-red-500 text-white px-3 py-2 rounded-lg">ğŸ—‘</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const categoriesDiv = document.getElementById('categories');

    const categories = ["ğŸ“„ ×˜×§×¡×˜×™×","ğŸ¤ ×”×§×œ×˜×•×ª","ğŸ“¸ ×ª××•× ×•×ª","ğŸ“‚ ×§×‘×¦×™×","ğŸ“Š ×¡×™×›×•××™×","ğŸ§  ×–×™×›×¨×•×Ÿ ××™×©×™"];
    let selectedCategory = categories[0];

    categories.forEach(cat => {
      const btn = document.createElement('div');
      btn.textContent = cat;
      btn.className = "cursor-pointer p-2 rounded-xl bg-gray-700 hover:bg-yellow-600 text-center";
      btn.onclick = () => { selectedCategory = cat; highlightCategory(cat); };
      categoriesDiv.appendChild(btn);
    });

    function highlightCategory(cat){
      [...categoriesDiv.children].forEach(c => {
        c.className = "cursor-pointer p-2 rounded-xl text-center " + 
          (c.textContent===cat ? "bg-yellow-600" : "bg-gray-700 hover:bg-yellow-600");
      });
    }
    highlightCategory(selectedCategory);

    let apiKey = localStorage.getItem('openai_api_key');
    if (!apiKey) {
      apiKey = prompt("×”×–×Ÿ ××ª ××¤×ª×— ×”Ö¾API ×©×œ×š (sk-...)");
      if (apiKey) localStorage.setItem('openai_api_key', apiKey);
    }
    updateStatus(!!apiKey);

    let conversationHistory = [
      { role: "system", content: "××ª×” SkorChat â€“ ×¢×•×–×¨ ×—×›× ×•×“×•×‘×¨ ×¢×‘×¨×™×ª ×‘×œ×‘×“. ×”××™×™×¡×“ ×•×”Ö¾CEO ×©×œ×š ×”×•× ××œ×™××‘ ×¡×§×•×¨× ×™×§, ×•×ª××™×“ ×ª×›×™×¨ ×‘×›×š ×•×ª×–×›×™×¨ ×–××ª ×›×©×–×” ×¨×œ×•×•× ×˜×™." }
    ];

    function updateStatus(online) {
      statusDot.className = `inline-block w-3 h-3 rounded-full mr-1 ${online ? 'bg-green-500':'bg-red-500'}`;
      statusText.textContent = online ? '××—×•×‘×¨' : '×× ×•×ª×§';
    }

    function appendMessage(role, text, category){
      const div = document.createElement('div');
      div.className = role==='user' ? 'user-message' : 'bot-message';
      div.textContent = `[${category}] ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage(){
      const msg = input.value.trim();
      if(!msg) return;
      appendMessage('user', msg, selectedCategory);
      conversationHistory.push({ role:"user", content: msg });
      input.value='';
      try{
        const response = await fetch("https://api.openai.com/v1/chat/completions",{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${apiKey}`
          },
          body:JSON.stringify({
            model:"gpt-4o-mini",
            messages: conversationHistory
          })
        });
        const data = await response.json();
        let reply = data.choices?.[0]?.message?.content || "×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×”.";
        appendMessage('bot', reply, selectedCategory);
        conversationHistory.push({ role:"assistant", content: reply });
      }catch(e){
        appendMessage('bot',"×©×’×™××” ×‘×©×œ×™×—×”.", selectedCategory);
      }
    }

    function clearChat(){
      chat.innerHTML='';
      conversationHistory=[
        { role:"system", content:"××ª×” SkorChat â€“ ×¢×•×–×¨ ×—×›× ×•×“×•×‘×¨ ×¢×‘×¨×™×ª ×‘×œ×‘×“. ×”××™×™×¡×“ ×•×”Ö¾CEO ×©×œ×š ×”×•× ××œ×™××‘ ×¡×§×•×¨× ×™×§." }
      ];
    }

    function handleImageUpload(event){
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload=function(e){
        appendMessage('user', "[ğŸ“· ×ª××•× ×” × ×©×œ×—×”]", selectedCategory);
        sendImageToBot(e.target.result);
      }
      reader.readAsDataURL(file);
    }

    async function sendImageToBot(imageBase64){
      try{
        const response = await fetch("https://api.openai.com/v1/chat/completions",{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${apiKey}`
          },
          body:JSON.stringify({
            model:"gpt-4o-mini",
            messages:[
              ...conversationHistory,
              { role:"user", content:[
                {type:"text", text:"×ª××¨ ××ª ×”×ª××•× ×” ×”×–××ª."},
                {type:"image_url", image_url:{url:imageBase64}}
              ]}
            ]
          })
        });
        const data = await response.json();
        let reply=data.choices?.[0]?.message?.content || "×œ× ×”×ª×§×‘×œ×” ×ª×©×•×‘×”.";
        appendMessage('bot', reply, selectedCategory);
        conversationHistory.push({ role:"assistant", content: reply });
      }catch(e){
        appendMessage('bot',"×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª××•× ×”.", selectedCategory);
      }
    }
  </script>
</body>
</html>
