<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skor-Heroes | Elite Global</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Rubik:wght@400;900&display=swap');
        :root { --primary: #00f2ff; --secondary: #ff007a; --gold: #ffcc00; --bg: #050510; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: 'Rubik', sans-serif; overflow: hidden; }
        
        #webcam-view { position: fixed; inset: 0; z-index: 0; transform: scaleX(-1); opacity: 0.15; filter: brightness(1.2); }
        video { width: 100%; height: 100%; object-fit: cover; }
        #canvas-container { position: absolute; inset: 0; z-index: 2; }

        /* UI Elements */
        .game-ui { position: absolute; inset: 0; z-index: 10; pointer-events: none; padding: 20px; }
        .score-box { background: rgba(0,0,0,0.8); border: 2px solid var(--primary); padding: 10px 20px; border-radius: 50px; font-family: 'Luckiest Guy'; font-size: 2rem; box-shadow: 0 0 15px var(--primary); }
        
        /* Overlays */
        .overlay-screen { position: fixed; inset: 0; background: rgba(5, 5, 16, 0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .play-btn { background: var(--gold); border: none; padding: 15px 50px; font-size: 2rem; font-family: 'Luckiest Guy'; border-radius: 20px; cursor: pointer; box-shadow: 0 8px 0 #b38f00; pointer-events: auto; transition: 0.1s; }
        .play-btn:active { transform: translateY(4px); box-shadow: 0 4px 0 #b38f00; }

        /* Selfie Preview */
        #selfie-canvas { border: 5px solid var(--gold); border-radius: 15px; max-width: 80%; display: none; margin-bottom: 20px; }
        .download-btn { background: var(--secondary); margin-top: 10px; }
    </style>
</head>
<body>

    <div id="boot-screen" class="overlay-screen">
        <h1 style="font-family: 'Luckiest Guy'; font-size: 5rem; color: var(--primary); margin: 0;">SKOR-HEROES</h1>
        <p style="color: var(--gold); font-weight: 900; font-size: 1.5rem;">BY ELIAV SKORNICK</p>
        <button class="play-btn" onclick="startGame()">ENTER MISSION</button>
    </div>

    <div id="win-screen" class="overlay-screen" style="display: none;">
        <h1 style="font-family: 'Luckiest Guy'; color: var(--gold); font-size: 3rem;">MISSION COMPLETE!</h1>
        <canvas id="selfie-canvas"></canvas>
        <div style="display: flex; gap: 10px;">
            <button class="play-btn download-btn" onclick="downloadSelfie()">SAVE STORY</button>
            <button class="play-btn" onclick="nextLevel()">NEXT LEVEL</button>
        </div>
    </div>

    <div id="webcam-view"><video id="webcam" autoplay playsinline></video></div>
    <div id="canvas-container"></div>

    <div class="game-ui">
        <div class="score-box" id="score-display" style="width: fit-content;">0000</div>
    </div>

    <script>
        let scene, camera, renderer, audioCtx, musicOsc;
        let handCursor, handTarget = new THREE.Vector3();
        let gameItems = [], isPinching = false;
        let gameState = { level: 1, score: 0, active: false };

        // --- 1. SOUND SYSTEM (Action Music & SFX) ---
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // Start simple background loop
            const loop = () => {
                if(!gameState.active) return;
                playNote(110, 'sawtooth', 0.5, 0.1); // Bass
                setTimeout(() => playNote(164, 'sawtooth', 0.5, 0.1), 250);
                setTimeout(loop, 500);
            };
            loop();
        }

        function playNote(freq, type, dur, vol) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // --- 2. SELFIE SYSTEM ---
        function captureHeroSelfie() {
            const video = document.getElementById('webcam');
            const selfieCanvas = document.getElementById('selfie-canvas');
            const ctx = selfieCanvas.getContext('2d');
            
            selfieCanvas.width = video.videoWidth;
            selfieCanvas.height = video.videoHeight;
            
            // Draw Webcam (Mirrored)
            ctx.translate(selfieCanvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            
            // Add UI Overlays
            ctx.fillStyle = "#ffcc00";
            ctx.font = "bold 50px Luckiest Guy";
            ctx.fillText("SKOR-HEROES", 30, 70);
            ctx.fillStyle = "white";
            ctx.font = "40px Rubik";
            ctx.fillText(`SCORE: ${gameState.score}`, 30, 120);
            ctx.fillText(`LEVEL ${gameState.level} CLEARED`, 30, 170);

            selfieCanvas.style.display = 'block';
        }

        function downloadSelfie() {
            const link = document.createElement('a');
            link.download = `skor-hero-level${gameState.level}.png`;
            link.href = document.getElementById('selfie-canvas').toDataURL();
            link.click();
        }

        // --- 3. GAME ENGINE ---
        async function startGame() {
            document.getElementById('boot-screen').style.display = 'none';
            initAudio();
            initThree();
            
            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.7 });
            hands.onResults(onHandResults);

            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            new Camera(video, { onFrame: async () => await hands.send({image: video}) }).start();

            setupLevel();
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.z = 250;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            const cursorGeo = new THREE.TorusGeometry(10, 2, 16, 32);
            handCursor = new THREE.Mesh(cursorGeo, new THREE.MeshBasicMaterial({ color: 0x00f2ff }));
            scene.add(handCursor);
            animate();
        }

        function onHandResults(res) {
            if (!gameState.active || !res.multiHandLandmarks?.[0]) return;
            const lm = res.multiHandLandmarks[0][8];
            const thumb = res.multiHandLandmarks[0][4];
            
            handTarget.x = (0.5 - lm.x) * 450;
            handTarget.y = (0.5 - lm.y) * 300;

            const dist = Math.sqrt(Math.pow(lm.x-thumb.x, 2) + Math.pow(lm.y-thumb.y, 2));
            if(dist < 0.06 && !isPinching) {
                isPinching = true;
                triggerShockwave();
            } else if(dist > 0.1) isPinching = false;
        }

        function triggerShockwave() {
            playNote(600, 'square', 0.1, 0.1); // SFX
            const wave = new THREE.Mesh(new THREE.RingGeometry(1, 2, 32), new THREE.MeshBasicMaterial({ color: 0x00f2ff, transparent: true }));
            wave.position.copy(handCursor.position);
            scene.add(wave);
            gsap.to(wave.scale, { x: 50, y: 50, duration: 0.3, onComplete: () => scene.remove(wave) });
            
            [...gameItems].forEach(item => {
                if(item.position.distanceTo(handCursor.position) < 60) {
                    playNote(100, 'sawtooth', 0.3, 0.2); // Hit SFX
                    gameState.score += 100;
                    scene.remove(item);
                    gameItems.splice(gameItems.indexOf(item), 1);
                }
            });
            if(gameItems.length === 0) {
                gameState.active = false;
                captureHeroSelfie();
                document.getElementById('win-screen').style.display = 'flex';
            }
            document.getElementById('score-display').innerText = gameState.score.toString().padStart(4, '0');
        }

        function setupLevel() {
            gameState.active = true;
            document.getElementById('win-screen').style.display = 'none';
            for(let i=0; i < 5 + gameState.level; i++) {
                const m = new THREE.Mesh(new THREE.IcosahedronGeometry(15), new THREE.MeshStandardMaterial({ color: 0xff007a }));
                m.position.set((Math.random()-0.5)*300, (Math.random()-0.5)*200, 0);
                scene.add(m);
                gameItems.push(m);
            }
            scene.add(new THREE.PointLight(0xffffff, 1));
        }

        function nextLevel() { gameState.level++; setupLevel(); }

        function animate() {
            requestAnimationFrame(animate);
            if(handCursor) {
                handCursor.position.lerp(handTarget, 0.2);
                handCursor.rotation.z += 0.1;
            }
            gameItems.forEach(i => i.rotation.y += 0.03);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
